<!DOCTYPE html>
<html lang="en">
<head>
    <title>Mongo playground</title>
    <meta name="description" content="Mongo playground: a simple sandbox to test and share MongoDB queries">
    <link href="/static/playground-min-2.css" rel="stylesheet" type="text/css">
    <script src="/static/playground-min-2.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.3.3/ace.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.3.3/mode-javascript.js" type="text/javascript"></script>
    <script type="text/javascript">
        var configEditor, queryEditor, resultEditor

        window.onload = function () {
            var configDiv = document.getElementById("config")
            var queryDiv = document.getElementById("query")
            configDiv.innerHTML = indent(configDiv.innerHTML, indentMode)
            queryDiv.innerHTML = indent(queryDiv.innerHTML, indentMode)

            var commonOpts = {
                "mode": "ace/mode/javascript",
                "fontSize": "16px"
            }
            configEditor = ace.edit(document.getElementById("config"), commonOpts)
            queryEditor = ace.edit(document.getElementById("query"), commonOpts)
            resultEditor = ace.edit(document.getElementById("result"), {
                "mode": commonOpts.mode,
                "fontSize": commonOpts.fontSize,
                "readOnly": true,
                "showLineNumbers": false,
                "showGutter": false,
                "useWorker": false,
                "highlightActiveLine": false
            })
            configEditor.getSession().on('change', function () { redirect("/", false) })
            queryEditor.getSession().on('change', function () { redirect("/", false) })

            var r = new XMLHttpRequest()
            r.open("GET", "/static/docs-2.html", true)
            r.onreadystatechange = function () {
                if (r.readyState !== 4) { return }
                if (r.status === 200) {
                    document.getElementById("docContent").innerHTML = r.responseText
                }
            }
            r.send(null)
        }

        function redirect(url, showLink) {
            window.history.replaceState({}, "MongoDB playground", url)
            document.getElementById("link").style.visibility = showLink ? "visible" : "hidden"
            document.getElementById("link").value = url
            document.getElementById("share").disabled = showLink
        }

        function showDoc(doShow) {
            if (doShow && document.getElementById("docDiv").style.display === "inline") {
                doShow = false
            }
            document.getElementById("docDiv").style.display = doShow ? "inline" : "none"
            document.getElementById("queryDiv").style.display = doShow ? "none" : "inline"
            document.getElementById("resultDiv").style.display = doShow ? "none" : "inline"
            if (!doShow) {
                redirect("/", false)
            }
        }

        function run(doSave) {
            if (isCorrect()) {
                var r = new XMLHttpRequest()
                r.open("POST", doSave ? "/save/" : "/run/")
                r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded")
                r.onreadystatechange = function () {
                    if (r.readyState !== 4) { return }
                    if (r.status === 200) {
                        if (doSave) {
                            redirect(r.responseText, true)
                        }
                        else {
                            var response = r.responseText
                            if (response.startsWith("[")) {
                                response = indent(response, indentMode)
                            }
                            resultEditor.setValue(response, -1)
                        }
                    }
                }
                var select = document.getElementById("mode")
                r.send("mode=" + select.options[select.selectedIndex].text
                    + "&config=" + encodeURIComponent(indent(configEditor.getValue(), compactMode))
                    + "&query=" + encodeURIComponent(indent(queryEditor.getValue(), compactMode)))
            }
        }

        function isCorrect() {
            showDoc(false)
            resultEditor.setValue("", -1)
            var errors = document.querySelectorAll(".ace_error")
            if (errors.length > 0) {
                resultEditor.setValue("error(s) found in config or query", -1)
                return false
            }

            var content = configEditor.getValue().trim()
            if (!content.startsWith("[") || !content.endsWith("]")) {
                resultEditor.setValue("invalid config: must be an array")
                return false
            }
            configEditor.setValue(indent(content, indentMode), -1)

            content = queryEditor.getValue().trim()
            if (content.endsWith(";")) {
                content = content.slice(0, -1)
            }
            var correctQuery = /^db\..(\w+)\.(find|aggregate)\([\s\S]*\)$/.test(content)
            if (!correctQuery) {
                resultEditor.setValue("invalid query: \nmust match db.coll.find(...) or db.coll.aggregate(...)", -1)
                return false
            }
            queryEditor.setValue(indent(content, indentMode), -1)
            return true
        }
    </script>
</head>
<body>
    <div id="top">
        <div id="title">Mongo Playground</div>
        <div id="controls">
            <input type="button" value="run" onclick="run(false)">
            <input type="button" value="Format" onclick="isCorrect()">
            <input id="share" type="button" value="share" onclick="run(true)">
            <input id="link" type="text">
            <label>Mode:
                <select id="mode" onchange="redirect('/', false)">
                    <option>mgodatagen</option>
                    <option {{if .ModeJSON}}selected="selected" {{end}}>json</option>
                </select>
            </label>
        </div>
        <div id="doc">
            <input type="button" value="documentation" onclick="showDoc(true)">
        </div>
    </div>
    <div id="content">
        <div id="configDiv" class="column">
            <h3 class="divTitle">Configuration</h3>
            <div id="config" class="ignoreWarnings">{{printf "%s" .Config}}</div>
        </div>
        <div id="queryDiv" class="column">
            <h3 class="divTitle">Query</h3>
            <div id="query">{{printf "%s" .Query}}</div>
        </div>
        <div id="resultDiv" class="column">
            <h3 class="divTitle">result</h3>
            <div id="result"></div>
        </div>
        <div id="docDiv" class="column">
            <h3></h3>
            <div id="docContent" class="markdown-body"></div>
        </div>
    </div>
    <div id="bottom">
        <div id="versionDiv">MongoDB version {{ printf "%s" .MongoVersion }} - Source code is available on github:
            <a href="https://github.com/feliixx/mongoplayground">feliixx/mongoplayground</a>
        </div>
    </div>
</body>
</html>